<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamCloud | Admin & Customer Portal</title>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root { --primary: #6c5ce7; --secondary: #a29bfe; --dark: #2d3436; --light: #f4f7f6; --success: #00b894; --warning: #fdcb6e; --info: #0984e3; }
        * { box-sizing: border-box; font-family: 'Poppins', sans-serif; margin: 0; padding: 0; }
        body { background: var(--light); color: var(--dark); }

        .auth-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(45deg, #6c5ce7, #a29bfe, #fd79a8, #6c5ce7);
            background-size: 400% 400%; animation: gradientBG 12s ease infinite;
            z-index: 9999; display: flex; justify-content: center; align-items: center; 
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .auth-card { background: white; padding: 50px 40px; border-radius: 30px; width: 420px; box-shadow: 0 25px 50px rgba(0,0,0,0.2); text-align: center; }
        .input-group { position: relative; margin-bottom: 15px; }
        input, select, textarea { width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 12px; outline: none; }
        .pass-wrapper { position: relative; }
        .eye-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #aaa; }

        nav { background: white; padding: 1rem 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        .container { padding: 2rem 5%; max-width: 1300px; margin: 0 auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 2rem; }
        .card { background: white; padding: 1.2rem; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.03); cursor: pointer; transition: 0.3s; }
        .card:hover { transform: translateY(-5px); }
        .card img { width: 100%; height: 180px; object-fit: cover; border-radius: 15px; }

        .status-select { padding: 8px; border-radius: 8px; font-weight: bold; border: 1px solid #ddd; cursor: pointer; outline: none; }
        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .status-Pending { background: #ffeaa7; color: #d35400; }
        .status-Shipped { background: #81ecec; color: #0984e3; }
        .status-Delivered { background: #55efc4; color: #00b894; }

        .table-container { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); overflow-x: auto; margin-bottom: 30px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #f0f0f0; }
        th { color: var(--primary); }

        .btn { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 12px; cursor: pointer; font-weight: 600; }
        .chatbot { position: fixed; bottom: 20px; right: 20px; background: #25d366; color: white; width: 55px; height: 55px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; z-index: 1000; text-decoration: none; }
        
        #productDetailView { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 500; display: none; overflow-y: auto; padding: 50px 10%; }
        .pdf-btn { background: none; border: none; color: #e74c3c; cursor: pointer; font-size: 1.2rem; }
        .qr-container { text-align: center; margin-top: 15px; display: none; padding: 10px; border: 1px dashed var(--primary); border-radius: 10px; background: #fff; }
    </style>
</head>
<body>

<div id="authScreen" class="auth-overlay">
    <div class="auth-card">
        <div style="font-size: 3rem; color: var(--primary);"><i class="fas fa-cloud-moon"></i></div>
        <h2 style="margin-bottom: 5px;">DREAMCLOUD</h2>
        <div class="input-group"><select id="authRole"><option value="customer">Customer Access</option><option value="admin">Admin Portal</option></select></div>
        <div class="input-group"><input type="text" id="authUser" placeholder="Email Address"></div>
        <div class="input-group pass-wrapper"><input type="password" id="authPass" placeholder="Password"><i class="fas fa-eye eye-icon" onclick="togglePassword(this)"></i></div>
        <button class="btn" id="authBtn" style="width: 100%;" onclick="handleAuth()">Login</button>
        <p id="toggleText" style="margin-top: 20px; cursor: pointer; color: var(--primary); font-size: 0.8rem;" onclick="toggleReg()">New User? Register here</p>
    </div>
</div>

<div id="mainApp" style="display:none;">
    <nav>
        <div style="font-weight: 800; color: var(--primary); font-size: 1.4rem;">DREAMCLOUD</div>
        <div style="display: flex; gap: 20px; align-items: center;">
            <div id="userWelcome" style="font-weight: 600;"></div>
            <div onclick="openCart()" style="cursor: pointer; position: relative;"><i class="fas fa-shopping-cart"></i><span id="cartCount" style="background: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.7rem; position: absolute; top: -10px; right: -10px;">0</span></div>
            <button class="btn" onclick="logout()" style="background: #eee; color: #333; padding: 5px 15px;">Logout</button>
        </div>
    </nav>

    <div class="container">
        <div id="adminPanel" style="display: none;">
            <div class="table-container">
                <h3>Add New Product</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;"><input type="text" id="pName" placeholder="Product Name"><input type="number" id="pPrice" placeholder="Price"></div>
                <textarea id="pDesc" placeholder="Product details..." style="margin-top: 10px;"></textarea>
                <input type="file" id="pImg" style="margin-top: 10px;" accept="image/*">
                <button class="btn" id="uploadBtn" style="width: 100%; margin-top: 10px;">Upload to Cloud</button>
            </div>
            <h3>Orders Management</h3>
            <div class="table-container"><table><thead><tr><th>Date</th><th>ID</th><th>User</th><th>Address</th><th>Total</th><th>Action Status</th></tr></thead><tbody id="adminOrders"></tbody></table></div>
        </div>

        <div id="customerPanel" style="display: none;">
            <h3>Your Recent Orders</h3>
            <div class="table-container"><table><thead><tr><th>Date</th><th>ID</th><th>Total</th><th>Status</th><th>Receipt</th></tr></thead><tbody id="custOrders"></tbody></table></div>
        </div>

        <h2 style="margin: 20px 0;">Our Collection</h2>
        <div id="productGrid" class="grid"></div>
    </div>
</div>

<a href="https://wa.me/919047806132" class="chatbot" target="_blank">
    <i class="fab fa-whatsapp"></i>
</a>

<div id="receiptTemplate" style="position: absolute; left: -9999px; padding: 40px; width: 600px; background: white; color: #333;">
    <h1 style="color: #6c5ce7; margin-bottom: 5px;">DREAMCLOUD</h1>
    <p>Premium Sleep Solutions</p>
    <hr style="margin: 20px 0;">
    <h3>INVOICE</h3>
    <p><b>Order ID:</b> <span id="rId"></span></p>
    <p><b>Date:</b> <span id="rDate"></span></p>
    <hr>
    <p><b>Shipping To:</b></p>
    <p id="rAddr"></p>
    <p><b>Phone:</b> <span id="rPhone"></span></p>
    <hr>
    <table style="width: 100%; margin-top: 20px;">
        <thead><tr style="background: #f0f0f0; text-align: left;"><th>Item</th><th>Price</th></tr></thead>
        <tbody id="rItems"></tbody>
    </table>
    <h2 style="text-align: right; margin-top: 20px;">Total: ₹<span id="rTotal"></span></h2>
</div>

<div id="productDetailView">
    <button class="btn" onclick="closeDetail()" style="background: #333; margin-bottom: 20px;"><i class="fa fa-arrow-left"></i> Back</button>
    <div style="display: flex; gap: 40px; flex-wrap: wrap;">
        <img id="detailImg" style="width: 400px; border-radius: 20px;">
        <div style="flex: 1;"><h1 id="detailTitle"></h1><h2 id="detailPrice" style="color: var(--primary);"></h2><p id="detailText"></p><div id="detailAction"></div></div>
    </div>
</div>

<div id="cartModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
    <div style="background: white; padding: 30px; border-radius: 20px; width: 400px; max-height: 90vh; overflow-y: auto;">
        <h3>Shopping Cart</h3>
        <div id="cartList" style="margin: 15px 0;"></div>
        <h4 id="cartTotal"></h4>
        <div id="checkForm" style="display: none;">
            <input type="text" id="addrPhone" placeholder="Mobile" style="margin-bottom:10px;">
            <textarea id="addrFull" placeholder="Address" style="margin-bottom:10px;"></textarea>
            <select id="payMethod" style="margin-bottom:10px;" onchange="toggleUPI(this.value)">
                <option value="COD">Cash On Delivery (COD)</option>
                <option value="UPI">UPI Payment (QR Scan)</option>
            </select>
            <div id="upiQRBox" class="qr-container">
                <p style="font-size: 0.8rem; margin-bottom: 5px;">Scan to Pay ₹<span id="qrAmount"></span></p>
                <img id="qrImg" src="" style="width: 180px; height: 180px; display: block; margin: 0 auto;">
                <p style="font-size: 0.7rem; color: #666; margin-top: 5px;">pratheep9047806132@oksbi</p>
            </div>
            <button class="btn" id="confirmOrderBtn" style="width:100%; margin-top:10px;">Place Order</button>
        </div>
        <button class="btn" id="chkBtn" onclick="document.getElementById('checkForm').style.display='block'; this.style.display='none'; updateQRAmount();" style="width: 100%; margin-top:10px;">Proceed</button>
        <button class="btn" onclick="document.getElementById('cartModal').style.display='none'" style="width:100%; background:none; color:red; margin-top:5px;">Close</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDo9Px6n63ciURSSU3xVKyV7I3vsqBcDcQ",
        authDomain: "dream-cloud-0012.firebaseapp.com",
        projectId: "dream-cloud-0012",
        storageBucket: "dream-cloud-0012.firebasestorage.app",
        messagingSenderId: "35293599964",
        appId: "1:35293599964:web:71d565f8e3d806decdfc19"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let products = [], cart = [], orders = [], activeUser = JSON.parse(localStorage.getItem('m_session'));

    window.onload = () => { if(activeUser) loginSuccess(activeUser); syncData(); };

    function syncData() {
        onSnapshot(collection(db, "products"), (snap) => {
            products = snap.docs.map(d => ({id: d.id, ...d.data()}));
            renderProductsUI();
        });
        
        onSnapshot(query(collection(db, "orders"), orderBy("timestamp", "desc")), (snap) => {
            orders = snap.docs.map(d => ({id: d.id, ...d.data()}));
            renderOrdersUI();
        });
    }

    window.handleAuth = async () => {
        const u = document.getElementById('authUser').value;
        const p = document.getElementById('authPass').value;
        const r = document.getElementById('authRole').value;
        const isRegMode = document.getElementById('toggleText').innerText.includes("Login");

        if(!u || !p) return Swal.fire('Error', 'Email and Password fill pannunga', 'error');

        if(isRegMode) {
            try {
                const q = query(collection(db, "users"));
                const snap = await getDocs(q);
                if(snap.docs.find(d => d.data().email === u)) return Swal.fire('Error', 'User already exists!', 'error');

                await addDoc(collection(db, "users"), {
                    email: u,
                    password: p,
                    role: r,
                    createdAt: serverTimestamp()
                });
                Swal.fire('Success!', 'Registration Successful! Please Login.', 'success');
                toggleReg();
            } catch (e) {
                Swal.fire('Error', 'Registration Failed', 'error');
            }
        } else {
            if(r==='admin' && u==='admin' && p==='admin123') {
                loginSuccess({u, r});
            } else {
                const q = query(collection(db, "users"));
                const snap = await getDocs(q);
                const user = snap.docs.find(d => d.data().email === u && d.data().password === p && d.data().role === r);
                
                if(user) {
                    loginSuccess({u: user.data().email, r: user.data().role});
                } else {
                    Swal.fire('Error', 'Invalid Credentials or Role!', 'error');
                }
            }
        }
    };

    window.toggleReg = () => {
        const t = document.getElementById('toggleText');
        const b = document.getElementById('authBtn');
        if(t.innerText.includes("Register")) {
            t.innerText = "Already have an account? Login here";
            b.innerText = "Register Now";
        } else {
            t.innerText = "New User? Register here";
            b.innerText = "Login";
        }
    };

    function loginSuccess(user) {
        activeUser = user; localStorage.setItem('m_session', JSON.stringify(user));
        document.getElementById('authScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.getElementById('userWelcome').innerText = "Hi, " + user.u;
        document.getElementById('adminPanel').style.display = user.r === 'admin' ? 'block' : 'none';
        document.getElementById('customerPanel').style.display = user.r === 'customer' ? 'block' : 'none';
    }

    window.logout = () => { localStorage.removeItem('m_session'); location.reload(); };

    document.getElementById('uploadBtn').onclick = async () => {
        const n = document.getElementById('pName').value, 
              p = document.getElementById('pPrice').value, 
              d = document.getElementById('pDesc').value, 
              i = document.getElementById('pImg').files[0];
        
        if(!n || !p || !i) return Swal.fire('Error', 'Ellaa field-um fill pannunga', 'error');
        
        Swal.fire({ title: 'Processing Image...', text: 'Compressing...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); }});

        const reader = new FileReader(); 
        reader.readAsDataURL(i);
        reader.onload = (e) => { 
            const img = new Image();
            img.src = e.target.result;
            img.onload = async () => {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 800; 
                const scaleSize = MAX_WIDTH / img.width;
                canvas.width = MAX_WIDTH;
                canvas.height = img.height * scaleSize;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);

                try {
                    await addDoc(collection(db, "products"), {
                        name: n, price: parseInt(p), desc: d, img: compressedBase64, createdAt: serverTimestamp()
                    }); 
                    Swal.fire('Success!', 'Product added!', 'success');
                    document.getElementById('pName').value = ''; document.getElementById('pPrice').value = '';
                    document.getElementById('pDesc').value = ''; document.getElementById('pImg').value = '';
                } catch (err) {
                    Swal.fire('Error', 'Upload failed', 'error');
                }
            };
        };
    };

    function renderProductsUI() {
        document.getElementById('productGrid').innerHTML = products.map(p => `<div class="card" onclick="openDetail('${p.id}')"><img src="${p.img}"><h4>${p.name}</h4><p>₹${p.price}</p></div>`).join('');
    }

    window.openDetail = (id) => {
        const p = products.find(x => x.id === id);
        if(!p) return;
        document.getElementById('detailTitle').innerText = p.name; 
        document.getElementById('detailPrice').innerText = "₹" + p.price;
        document.getElementById('detailImg').src = p.img; 
        document.getElementById('detailText').innerText = p.desc;
        document.getElementById('detailAction').innerHTML = activeUser.r==='customer' 
            ? `<button class="btn" onclick="addToCart('${p.id}')">Add to Cart</button>` 
            : `<button class="btn" style="background:red" onclick="deleteProd('${p.id}')">Delete Product</button>`;
        document.getElementById('productDetailView').style.display = 'block';
    };

    window.deleteProd = async (id) => {
        const confirm = await Swal.fire({ title: 'Delete?', icon: 'warning', showCancelButton: true });
        if(confirm.isConfirmed) {
            await deleteDoc(doc(db, "products", id));
            closeDetail();
            Swal.fire('Deleted!', '', 'success');
        }
    };

    window.closeDetail = () => document.getElementById('productDetailView').style.display = 'none';

    window.addToCart = (id) => { 
        cart.push(products.find(x => x.id === id)); 
        document.getElementById('cartCount').innerText = cart.length; 
        Swal.fire({ title: 'Added!', icon: 'success', timer: 1000, showConfirmButton: false });
    };

    window.openCart = () => {
        document.getElementById('cartList').innerHTML = cart.map(i => `<div>${i.name} - ₹${i.price}</div>`).join('');
        document.getElementById('cartTotal').innerText = "Total: ₹" + cart.reduce((s,i)=>s+i.price, 0);
        document.getElementById('cartModal').style.display = 'flex';
    };

    window.toggleUPI = (val) => {
        const box = document.getElementById('upiQRBox');
        if(val === 'UPI') {
            box.style.display = 'block';
            updateQRAmount();
        } else {
            box.style.display = 'none';
        }
    };

    window.updateQRAmount = () => {
        const total = cart.reduce((s,i)=>s+i.price, 0);
        document.getElementById('qrAmount').innerText = total;
        const upiID = "pratheep9047806132@oksbi";
        const upiLink = `upi://pay?pa=${upiID}&pn=DreamCloud&am=${total}&cu=INR&tn=Order_Payment`;
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(upiLink)}`;
        document.getElementById('qrImg').src = qrUrl;
    };

    document.getElementById('confirmOrderBtn').onclick = async () => {
        const phone = document.getElementById('addrPhone').value;
        const address = document.getElementById('addrFull').value;
        const payMethod = document.getElementById('payMethod').value;
        
        if(!phone || !address) return Swal.fire('Error', 'Fill details', 'error');

        const oId = 'ORD' + Math.floor(10000 + Math.random() * 90000);
        const total = cart.reduce((s,i)=>s+i.price, 0);

        const oData = { 
            orderId: oId, user: activeUser.u, ph: phone, ad: address, 
            items: [...cart], total: total, status: 'Pending', 
            paymentMethod: payMethod,
            timestamp: serverTimestamp(), timeStr: new Date().toLocaleString() 
        };

        try {
            await addDoc(collection(db, "orders"), oData);
            
            emailjs.init("GUWZpUsjNplK0OgnI"); 

            const emailParams = {
                name: activeUser.u,
                message: "Items: " + cart.map(item => item.name).join(", "),
                order_id: oId, 
                total_amount: total, 
                address: address
            };

            emailjs.send("service_pt7lz3v", "template_1xd92ti", emailParams)
                .then((res) => {
                    Swal.fire('Order Placed!', `Success! (${payMethod}) Email sent.`, 'success');
                })
                .catch((err) => {
                    console.error("EmailJS Error:", err);
                    Swal.fire('Order Placed!', 'Order saved. Email delivery issue (Check Public Key).', 'warning');
                });

            cart = []; 
            document.getElementById('cartCount').innerText = '0';
            document.getElementById('cartModal').style.display = 'none'; 
            document.getElementById('checkForm').style.display = 'none';
            document.getElementById('chkBtn').style.display = 'block';
            document.getElementById('upiQRBox').style.display = 'none';
        } catch (e) {
            Swal.fire('Error', 'Order failed!', 'error');
        }
    };

    window.updateStatus = async (id, newStatus) => {
        await updateDoc(doc(db, "orders", id), { status: newStatus });
        Swal.fire({ title: 'Updated!', icon: 'success', timer: 1000, showConfirmButton: false });
    };

    function renderOrdersUI() {
        document.getElementById('adminOrders').innerHTML = orders.map(o => `
            <tr><td>${o.timeStr}</td><td>${o.orderId}</td><td>${o.user}</td><td>${o.ad} (${o.paymentMethod || 'N/A'})</td><td>₹${o.total}</td>
                <td><select class="status-select" onchange="updateStatus('${o.id}', this.value)">
                    <option value="Pending" ${o.status==='Pending'?'selected':''}>Pending</option>
                    <option value="Shipped" ${o.status==='Shipped'?'selected':''}>Shipped</option>
                    <option value="Delivered" ${o.status==='Delivered'?'selected':''}>Delivered</option>
                </select></td></tr>`).join('');

        document.getElementById('custOrders').innerHTML = orders.filter(o => o.user === activeUser.u).map(o => `
            <tr><td>${o.timeStr ? o.timeStr.split(',')[0] : '...'}</td><td>${o.orderId}</td><td>₹${o.total}</td>
                <td><span class="status-badge status-${o.status}">${o.status}</span></td>
                <td><button class="pdf-btn" onclick="downloadInvoice('${o.orderId}')"><i class="fa fa-file-pdf"></i></button></td></tr>`).join('');
    }

    window.downloadInvoice = async (orderId) => {
        const o = orders.find(x => x.orderId === orderId);
        if(!o) return;
        document.getElementById('rId').innerText = o.orderId;
        document.getElementById('rDate').innerText = o.timeStr;
        document.getElementById('rAddr').innerText = o.ad;
        document.getElementById('rPhone').innerText = o.ph;
        document.getElementById('rTotal').innerText = o.total;
        document.getElementById('rItems').innerHTML = o.items.map(i => `<tr><td>${i.name}</td><td>₹${i.price}</td></tr>`).join('');
        const template = document.getElementById('receiptTemplate');
        template.style.left = "0px";
        html2canvas(template).then(canvas => {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 10, 10, 190, 0);
            pdf.save(`Invoice_${o.orderId}.pdf`);
            template.style.left = "-9999px";
        });
    }

    window.togglePassword = (i) => { const inp = i.previousElementSibling; inp.type = inp.type==='password'?'text':'password'; };
</script>
</body>
</html>
