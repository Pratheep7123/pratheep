<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamCloud | Admin & Customer Portal</title>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root { --primary: #6c5ce7; --secondary: #a29bfe; --dark: #2d3436; --light: #f4f7f6; --success: #00b894; --warning: #fdcb6e; --info: #0984e3; }
        * { box-sizing: border-box; font-family: 'Poppins', sans-serif; margin: 0; padding: 0; }
        body { background: var(--light); color: var(--dark); }

        /* --- LOGIN ANIMATION --- */
        .auth-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(45deg, #6c5ce7, #a29bfe, #fd79a8, #6c5ce7);
            background-size: 400% 400%; animation: gradientBG 12s ease infinite;
            z-index: 9999; display: flex; justify-content: center; align-items: center; 
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .auth-card { background: white; padding: 50px 40px; border-radius: 30px; width: 420px; box-shadow: 0 25px 50px rgba(0,0,0,0.2); text-align: center; }
        .input-group { position: relative; margin-bottom: 15px; }
        input, select, textarea { width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 12px; outline: none; }
        .pass-wrapper { position: relative; }
        .eye-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #aaa; }

        /* --- DASHBOARD --- */
        nav { background: white; padding: 1rem 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        .container { padding: 2rem 5%; max-width: 1300px; margin: 0 auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 2rem; }
        .card { background: white; padding: 1.2rem; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.03); cursor: pointer; transition: 0.3s; }
        .card:hover { transform: translateY(-5px); }
        .card img { width: 100%; height: 180px; object-fit: cover; border-radius: 15px; }

        /* --- STATUS BADGES --- */
        .status-select { padding: 5px; border-radius: 8px; font-weight: bold; border: none; cursor: pointer; }
        .status-Pending { background: #ffeaa7; color: #d35400; }
        .status-Shipped { background: #81ecec; color: #0984e3; }
        .status-Delivered { background: #55efc4; color: #00b894; }

        /* --- TABLES --- */
        .table-container { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); overflow-x: auto; margin-bottom: 30px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #f0f0f0; }
        th { color: var(--primary); }

        .btn { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 12px; cursor: pointer; font-weight: 600; }
        .chatbot { position: fixed; bottom: 20px; right: 20px; background: #25d366; color: white; width: 55px; height: 55px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; z-index: 1000; text-decoration: none; }
        
        #productDetailView { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 500; display: none; overflow-y: auto; padding: 50px 10%; }
    </style>
</head>
<body>

<div id="authScreen" class="auth-overlay">
    <div class="auth-card">
        <div style="font-size: 3rem; color: var(--primary);"><i class="fas fa-cloud-moon"></i></div>
        <h2 style="margin-bottom: 5px;">DREAMCLOUD</h2>
        <p style="color: #888; margin-bottom: 30px;">Premium Mattress Store</p>
        
        <div class="input-group">
            <select id="authRole">
                <option value="customer">Customer Access</option>
                <option value="admin">Admin Portal</option>
            </select>
        </div>
        <div class="input-group">
            <input type="text" id="authUser" placeholder="Email Address">
        </div>
        <div class="input-group pass-wrapper">
            <input type="password" id="authPass" placeholder="Password">
            <i class="fas fa-eye eye-icon" onclick="togglePassword(this)"></i>
        </div>
        <button class="btn" style="width: 100%;" onclick="handleAuth()">Login</button>
        <p id="toggleText" style="margin-top: 20px; cursor: pointer; color: var(--primary); font-size: 0.8rem;" onclick="toggleReg()">New User? Register here</p>
    </div>
</div>

<div id="mainApp" style="display:none;">
    <nav>
        <div style="font-weight: 800; color: var(--primary); font-size: 1.4rem;">DREAMCLOUD</div>
        <div style="display: flex; gap: 20px; align-items: center;">
            <div id="userWelcome" style="font-weight: 600;"></div>
            <div onclick="openCart()" style="cursor: pointer; position: relative;">
                <i class="fas fa-shopping-cart"></i>
                <span id="cartCount" style="background: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.7rem; position: absolute; top: -10px; right: -10px;">0</span>
            </div>
            <button class="btn" onclick="logout()" style="background: #eee; color: #333; padding: 5px 15px;">Logout</button>
        </div>
    </nav>

    <div class="container">
        <div id="adminPanel" style="display: none;">
            <div class="table-container">
                <h3>Add New Product</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                    <input type="text" id="pName" placeholder="Product Name">
                    <input type="number" id="pPrice" placeholder="Price">
                </div>
                <textarea id="pDesc" placeholder="Product details..." style="margin-top: 10px;"></textarea>
                <input type="file" id="pImg" style="margin-top: 10px;">
                <button class="btn" onclick="uploadProduct()" style="width: 100%; margin-top: 10px;">Upload</button>
            </div>

            <h3>Orders Management</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date & Time</th>
                            <th>Order ID</th>
                            <th>Customer & Contact</th>
                            <th>Shipping Address</th>
                            <th>Total</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="adminOrders"></tbody>
                </table>
            </div>
        </div>

        <div id="customerPanel" style="display: none;">
            <h3>Your Recent Orders</h3>
            <div class="table-container">
                <table>
                    <thead><tr><th>Date</th><th>ID</th><th>Total</th><th>Status</th><th>Receipt</th></tr></thead>
                    <tbody id="custOrders"></tbody>
                </table>
            </div>
        </div>

        <h2 style="margin: 20px 0;">Our Collection</h2>
        <div id="productGrid" class="grid"></div>
    </div>
</div>

<div id="productDetailView">
    <button class="btn" onclick="closeDetail()" style="background: #333; margin-bottom: 20px;"><i class="fa fa-arrow-left"></i> Back</button>
    <div style="display: flex; gap: 40px; flex-wrap: wrap;">
        <img id="detailImg" style="width: 400px; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.1);">
        <div style="flex: 1;">
            <h1 id="detailTitle"></h1>
            <h2 id="detailPrice" style="color: var(--primary); margin: 15px 0;"></h2>
            <p id="detailText" style="line-height: 1.6; color: #555; margin-bottom: 20px;"></p>
            <div id="detailAction"></div>
        </div>
    </div>
</div>

<div id="cartModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
    <div style="background: white; padding: 30px; border-radius: 20px; width: 400px;">
        <h3>Shopping Cart</h3>
        <div id="cartList" style="margin: 15px 0; max-height: 200px; overflow-y: auto;"></div>
        <h4 id="cartTotal"></h4>
        <div id="checkForm" style="display: none; margin-top: 15px;">
            <input type="text" id="addrPhone" placeholder="Contact Number" style="margin-bottom: 10px;">
            <textarea id="addrFull" placeholder="Full Shipping Address"></textarea>
            <button class="btn" onclick="placeOrder()" style="width: 100%; margin-top: 10px;">Confirm & Pay (COD)</button>
        </div>
        <button class="btn" id="chkBtn" onclick="document.getElementById('checkForm').style.display='block'; this.style.display='none'" style="width: 100%; margin-top: 10px;">Proceed</button>
        <button class="btn" onclick="this.parentElement.parentElement.style.display='none'" style="width:100%; background:none; color:red; margin-top: 5px;">Close</button>
    </div>
</div>

<div id="receiptTemplate" style="display:none; padding: 40px; width: 600px; background: white; color: #333;">
    <h1 style="color: #6c5ce7; margin-bottom: 5px;">DREAMCLOUD</h1>
    <p>Premium Sleep Solutions</p>
    <hr style="margin: 20px 0;">
    <h3>INVOICE</h3>
    <p><b>Order ID:</b> <span id="rId"></span></p>
    <p><b>Date:</b> <span id="rDate"></span></p>
    <hr>
    <p><b>Shipping To:</b></p>
    <p id="rAddr"></p>
    <p><b>Phone:</b> <span id="rPhone"></span></p>
    <hr>
    <table style="width: 100%; margin-top: 20px;">
        <thead><tr style="background: #f0f0f0;"><th>Item</th><th>Price</th></tr></thead>
        <tbody id="rItems"></tbody>
    </table>
    <h2 style="text-align: right; margin-top: 20px;">Total: ₹<span id="rTotal"></span></h2>
    <p style="margin-top: 40px; font-size: 0.8rem; text-align: center; color: #888;">Thank you for shopping with DreamCloud!</p>
</div>

<a href="https://wa.me/919047806132" class="chatbot"><i class="fab fa-whatsapp"></i></a>

<script>
    emailjs.init("GUWZpUsjNplK0OgnI");

    let products = JSON.parse(localStorage.getItem('m_products')) || [{id:1, name:"Cloud Mat", price:12000, desc:"Extra soft luxury mattress", img:"https://via.placeholder.com/400"}];
    let orders = JSON.parse(localStorage.getItem('m_orders')) || [];
    let users = JSON.parse(localStorage.getItem('m_users')) || {};
    let cart = [];
    let activeUser = JSON.parse(localStorage.getItem('m_session'));

    window.onload = () => { if(activeUser) loginSuccess(activeUser); renderProducts(); };

    function togglePassword(icon) {
        const input = icon.previousElementSibling;
        input.type = input.type === 'password' ? 'text' : 'password';
        icon.classList.toggle('fa-eye-slash');
    }

    function toggleReg() {
        const t = document.getElementById('toggleText');
        t.innerText = t.innerText.includes("Register") ? "Back to Login" : "New User? Register here";
    }

    function handleAuth() {
        const u = document.getElementById('authUser').value.trim();
        const p = document.getElementById('authPass').value.trim();
        const r = document.getElementById('authRole').value;
        const isReg = document.getElementById('toggleText').innerText.includes("Back");

        if(!u || !p) return alert("Fill all fields");

        if(r === 'admin') {
            if(u === 'admin' && p === 'admin123') loginSuccess({u, r});
            else alert("Invalid Admin");
        } else {
            if(isReg) {
                users[u] = p; localStorage.setItem('m_users', JSON.stringify(users));
                alert("Registered! Please login."); toggleReg();
            } else {
                if(users[u] === p) loginSuccess({u, r});
                else alert("Wrong credentials");
            }
        }
    }

    function loginSuccess(user) {
        activeUser = user;
        localStorage.setItem('m_session', JSON.stringify(user));
        document.getElementById('authScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.getElementById('userWelcome').innerText = "Hi, " + user.u.split('@')[0];
        document.getElementById('adminPanel').style.display = user.r === 'admin' ? 'block' : 'none';
        document.getElementById('customerPanel').style.display = user.r === 'customer' ? 'block' : 'none';
        renderOrders();
    }

    function logout() { localStorage.removeItem('m_session'); location.reload(); }

    function uploadProduct() {
        const n = document.getElementById('pName').value, p = document.getElementById('pPrice').value, d = document.getElementById('pDesc').value, i = document.getElementById('pImg').files[0];
        if(!n || !p || !i) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            products.push({id: Date.now(), name:n, price:parseInt(p), desc:d, img:e.target.result});
            localStorage.setItem('m_products', JSON.stringify(products));
            renderProducts(); alert("Product Added");
        };
        reader.readAsDataURL(i);
    }

    function renderProducts() {
        document.getElementById('productGrid').innerHTML = products.map(p => `
            <div class="card" onclick="openDetail(${p.id})">
                <img src="${p.img}">
                <h4 style="margin-top:10px;">${p.name}</h4>
                <p style="color:var(--primary); font-weight:bold;">₹${p.price}</p>
            </div>`).join('');
    }

    function openDetail(id) {
        const p = products.find(x => x.id === id);
        document.getElementById('detailTitle').innerText = p.name;
        document.getElementById('detailPrice').innerText = "₹" + p.price;
        document.getElementById('detailText').innerText = p.desc;
        document.getElementById('detailImg').src = p.img;
        document.getElementById('detailAction').innerHTML = activeUser.r === 'customer' ? 
            `<button class="btn" onclick="addToCart(${p.id})">Add to Cart</button>` : 
            `<button class="btn" style="background:red" onclick="deleteProd(${p.id})">Delete Product</button>`;
        document.getElementById('productDetailView').style.display = 'block';
    }

    function closeDetail() { document.getElementById('productDetailView').style.display = 'none'; }

    function deleteProd(id) {
        products = products.filter(x => x.id !== id);
        localStorage.setItem('m_products', JSON.stringify(products));
        closeDetail(); renderProducts();
    }

    function addToCart(id) {
        cart.push(products.find(x => x.id === id));
        document.getElementById('cartCount').innerText = cart.length;
        Swal.fire({icon:'success', title:'Added to cart', toast:true, position:'top-end', showConfirmButton:false, timer:1500});
    }

    function openCart() {
        document.getElementById('cartList').innerHTML = cart.map(i => `<div>${i.name} - ₹${i.price}</div>`).join('') || "Cart is empty";
        document.getElementById('cartTotal').innerText = "Total: ₹" + cart.reduce((s,i)=>s+i.price, 0);
        document.getElementById('cartModal').style.display = 'flex';
    }

    function placeOrder() {
        const ph = document.getElementById('addrPhone').value, ad = document.getElementById('addrFull').value;
        if(!ph || !ad) return alert("Enter shipping details");
        const total = cart.reduce((s,i)=>s+i.price, 0);
        const o = { 
            id: 'ORD'+Date.now().toString().slice(-5), 
            u: activeUser.u, ph, ad, 
            items: cart, total, 
            status: 'Pending', 
            time: new Date().toLocaleString() 
        };
        orders.push(o); localStorage.setItem('m_orders', JSON.stringify(orders));
        emailjs.send("service_cozymats", "template_gqz62kh", {to_email: o.u, order_id: o.id, total_value: total});
        cart = []; document.getElementById('cartCount').innerText = 0;
        document.getElementById('cartModal').style.display = 'none';
        Swal.fire('Order Placed!', 'Receipt sent to email', 'success');
        renderOrders();
    }

    function renderOrders() {
        document.getElementById('adminOrders').innerHTML = orders.map(o => `
            <tr>
                <td>${o.time}</td>
                <td><b>${o.id}</b></td>
                <td>${o.u}<br>${o.ph}</td>
                <td style="font-size:0.7rem;">${o.ad}</td>
                <td>₹${o.total}</td>
                <td>
                    <select class="status-select status-${o.status}" onchange="updateStatus('${o.id}', this.value)">
                        <option value="Pending" ${o.status==='Pending'?'selected':''}>Pending</option>
                        <option value="Shipped" ${o.status==='Shipped'?'selected':''}>Shipped</option>
                        <option value="Delivered" ${o.status==='Delivered'?'selected':''}>Delivered</option>
                    </select>
                </td>
            </tr>`).reverse().join('');

        if(activeUser.r === 'customer') {
            document.getElementById('custOrders').innerHTML = orders.filter(o => o.u === activeUser.u).map(o => `
                <tr>
                    <td>${o.time.split(',')[0]}</td>
                    <td>${o.id}</td>
                    <td>₹${o.total}</td>
                    <td class="status-${o.status}" style="padding:5px; border-radius:5px; text-align:center;">${o.status}</td>
                    <td><button onclick="downloadPDF('${o.id}')"><i class="fa fa-file-pdf"></i></button></td>
                </tr>`).reverse().join('');
        }
    }

    function updateStatus(id, stat) {
        orders = orders.map(o => o.id === id ? {...o, status: stat} : o);
        localStorage.setItem('m_orders', JSON.stringify(orders));
        renderOrders();
    }

    async function downloadPDF(id) {
        const o = orders.find(x => x.id === id);
        document.getElementById('rId').innerText = o.id;
        document.getElementById('rDate').innerText = o.time;
        document.getElementById('rAddr').innerText = o.ad;
        document.getElementById('rPhone').innerText = o.ph;
        document.getElementById('rTotal').innerText = o.total;
        document.getElementById('rItems').innerHTML = o.items.map(i => `<tr><td>${i.name}</td><td>₹${i.price}</td></tr>`).join('');
        
        const template = document.getElementById('receiptTemplate');
        template.style.display = 'block';
        
        html2canvas(template).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            pdf.addImage(imgData, 'PNG', 10, 10, 180, 0);
            pdf.save(`DreamCloud_Receipt_${o.id}.pdf`);
            template.style.display = 'none';
        });
    }
</script>
</body>
</html>